<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <title>MaskMap</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
    #map {
      width: 100%;
      height: 667px;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;

    }

    /* .table td,
    .table th {
      padding: 10px;
      text-align: center;
    } */
    .covid-19 {
      height: 200px;
    }

    #legend {
        font-family: Arial, sans-serif;
        background: #fff;
        padding: 10px;
        margin: 10px;
        border: 3px solid #000;
      }
      #legend h3 {
        margin-top: 0;
      }
      #legend img {
        vertical-align: middle;
      }
  </style>
</head>

<body>


  <div class="container">
    <div class="row">
      <div class="col-6 text-center m-auto">
        <h2>全球確診人數</h2>
        <table class="table table-sm">
          <thead>
            <tr>
              <th scope="col">Country</th>
              <th scope="col">Cases</th>
              <th scope="col">Deaths</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
    <div class="row covid-19 overflow-auto">
      <div class="col-6 text-center m-auto">
        <table class="table covid-19-table table-sm">
          <!-- Information -->
          <template id="templateTbody">
            <tbody id="covid-19-Tbody">
              <tr>
                <td id="country">Taiwan</td>
                <td id="cases">252</td>
                <td id="deaths">33</td>
              </tr>
            </tbody>
          </template>
        </table>
      </div>
    </div>
    <div class="row m-auto no-gutters">
      <div class="col-12 col-lg-12">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <a class="navbar-brand" href="#">區域</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
              <li>
                <button type="button" class="btn btn-outline-light">基隆市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">臺北市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">新北市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">桃園市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">新竹縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">新竹市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">苗栗縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">台中市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">南投縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">嘉義市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">嘉義縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">雲林縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">臺南市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">高雄市</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">屏東縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">臺東縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">花蓮縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">宜蘭縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">澎湖縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">金門縣</button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">連江縣</button>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <div class="col-12 col-lg-12 " id="map">
      
      </div>
    </div>
  </div>


  <div id="legend" class="b">
    <h5>詳細資訊請點擊圖釘</h5>
  </div>


  <script>
    var map;
    let maskData = '';
    var maskDataArray = [];
    var infoWindow;
    var markerInfoWindow;
    var detail = '';
    var covid19 = document.querySelector('.covid-19-table');
    var cities = document.querySelectorAll('ul>li .btn');
    var city = [{
        name: "基隆市",
        latlng: {
          lat: 25.1303462,
          lng: 121.7439138
        }
      },
      {
        name: "臺北市",
        latlng: {
          lat: 25.0375465,
          lng: 121.562244
        }
      },
      {
        name: "新北市",
        latlng: {
          lat: 25.0123073,
          lng: 121.4632665
        }
      },
      {
        name: "連江縣",
        latlng: {
          lat: 26.1572524,
          lng: 119.9482926
        }
      },
      {
        name: "宜蘭縣",
        latlng: {
          lat: 24.7305437,
          lng: 121.7619899
        }
      },
      {
        name: "新竹市",
        latlng: {
          lat: 24.7929419,
          lng: 120.9493054
        }
      },
      {
        name: "新竹縣",
        latlng: {
          lat: 24.8268841,
          lng: 121.010715
        }
      },
      {
        name: "桃園市",
        latlng: {
          lat: 24.9931617,
          lng: 121.2988176
        }
      },
      {
        name: "苗栗縣",
        latlng: {
          lat: 24.5648599,
          lng: 120.8185503
        }
      },
      {
        name: "台中市", //24.1892645,120.6090681
        latlng: {
          lat: 24.1892645,
          lng: 120.6090681
        }
      },
      {
        name: "南投縣", //23.9026841,120.6883151
        latlng: {
          lat: 23.9026841,
          lng: 120.6883151
        }
      },
      {
        name: "嘉義市", //23.4812545,120.4514023
        latlng: {
          lat: 23.4812545,
          lng: 120.4514023
        }
      },
      {
        name: "嘉義縣", //23.4586677,120.2907749
        latlng: {
          lat: 23.4586677,
          lng: 120.2907749
        }
      },
      {
        name: "雲林縣", //23.6992351,120.5241337
        latlng: {
          lat: 23.6992351,
          lng: 120.5241337
        }
      },
      {
        name: "臺南市", //22.9922336,120.18299
        latlng: {
          lat: 22.9922336,
          lng: 120.18299
        }
      },
      {
        name: "高雄市", //22.62025,120.3069565
        latlng: {
          lat: 22.62025,
          lng: 120.3069565
        }
      },
      {
        name: "澎湖縣", //23.568495,119.5668485
        latlng: {
          lat: 23.568495,
          lng: 119.5668485
        }
      },
      {
        name: "金門縣", //24.4371954,118.3171488
        latlng: {
          lat: 24.4371954,
          lng: 118.3171488
        }
      },
      {
        name: "屏東縣", //22.6830408,120.4857744
        latlng: {
          lat: 22.6830408,
          lng: 120.4857744
        }
      },
      {
        name: "臺東縣", //22.7539301,121.1429397
        latlng: {
          lat: 22.7539301,
          lng: 121.1429397
        }
      },
      {
        name: "花蓮縣", //23.9848788,121.5721311
        latlng: {
          lat: 23.9848788,
          lng: 121.5721311
        }
      }
    ];

    Getgeojson();
    cities.forEach((item) => {
      item.addEventListener('click', changeMap)
    })

    function initMap() { //程式一開始的入口
      let taipei = {
        lat: 25.0375465,
        lng: 121.562244
      };
      map = new google.maps.Map(document.getElementById('map'), {
        center: taipei,
        zoom: 15,
        styles: [
            {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
            {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
            {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
            {
              featureType: 'administrative.locality',
              elementType: 'labels.text.fill',
              stylers: [{color: '#d59563'}]
            },
            {
              featureType: 'poi',
              elementType: 'labels.text.fill',
              stylers: [{color: '#d59563'}]
            },
            {
              featureType: 'poi.park',
              elementType: 'geometry',
              stylers: [{color: '#263c3f'}]
            },
            {
              featureType: 'poi.park',
              elementType: 'labels.text.fill',
              stylers: [{color: '#6b9a76'}]
            },
            {
              featureType: 'road',
              elementType: 'geometry',
              stylers: [{color: '#38414e'}]
            },
            {
              featureType: 'road',
              elementType: 'geometry.stroke',
              stylers: [{color: '#212a37'}]
            },
            {
              featureType: 'road',
              elementType: 'labels.text.fill',
              stylers: [{color: '#9ca5b3'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'geometry',
              stylers: [{color: '#746855'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'geometry.stroke',
              stylers: [{color: '#1f2835'}]
            },
            {
              featureType: 'road.highway',
              elementType: 'labels.text.fill',
              stylers: [{color: '#f3d19c'}]
            },
            {
              featureType: 'transit',
              elementType: 'geometry',
              stylers: [{color: '#2f3948'}]
            },
            {
              featureType: 'transit.station',
              elementType: 'labels.text.fill',
              stylers: [{color: '#d59563'}]
            },
            {
              featureType: 'water',
              elementType: 'geometry',
              stylers: [{color: '#17263c'}]
            },
            {
              featureType: 'water',
              elementType: 'labels.text.fill',
              stylers: [{color: '#515c6d'}]
            },
            {
              featureType: 'water',
              elementType: 'labels.text.stroke',
              stylers: [{color: '#17263c'}]
            }
          ]
      });



      markerInfoWindow = new google.maps.InfoWindow;
      infoWindow = new google.maps.InfoWindow;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map.setCenter(pos);

          let marker = new google.maps.Marker({
            position: pos,
            map: map,
            title: 'You Are Here'
          });
        }, function () {
          handleLocationError(true, infoWindow, map.getCenter());
        });
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }
      GetDataInfo();
    }

    function GetDataInfo() {
      $.ajax({
        type: "GET",
        // url: "https://raw.githubusercontent.com/hsulei03/BS_homework/master/MaskMap/MaskData.json",
        // url: test1234,
        url: "https://findmasks.herokuapp.com/places",
        async: false,
        success: function (response) {
          // console.log("65598555")
          maskData = response;
          // maskData = JSON.parse(response);
          maskData["features"].forEach((item) => {
            maskDataArray.push({
              id: item.properties.id,
              name: item.properties.name,
              lat: item.geometry.coordinates[1],
              lng: item.geometry.coordinates[0],
              masksLeft: item.properties.masksLeft,
              childMasksLeft: item.properties.childMasksLeft
            })
          });
          setMarkers(map);
        }
      });

    }

    function setMarkers(map) {
      console.log(maskData);
      var image_o = {
        url: 'https://maps.google.com/mapfiles/kml/pal3/icon63.png',
        // This marker is 20 pixels wide by 32 pixels high.
        size: new google.maps.Size(32, 32),
        // The origin for this image is (0, 0).
        origin: new google.maps.Point(0, 0),
        // The anchor for this image is the base of the flagpole at (0, 32).
        anchor: new google.maps.Point(0, 32)
      };

      var image_x = {
        url: 'https://maps.google.com/mapfiles/kml/pal5/icon14.png',
        // This marker is 20 pixels wide by 32 pixels high.
        size: new google.maps.Size(32, 32),
        // The origin for this image is (0, 0).
        origin: new google.maps.Point(0, 0),
        // The anchor for this image is the base of the flagpole at (0, 32).
        anchor: new google.maps.Point(0, 32)
      };

      maskDataArray.forEach((item) => {
        let marker = new google.maps.Marker({
          position: {
            lat: item.lat,
            lng: item.lng
          },
          map: map,
          icon: item.masksLeft + item.childMasksLeft == 0 ? image_x : image_o,
          title: `${item.name}目前：成人有${item.masksLeft}，兒童有${item.childMasksLeft}`,
          customerProp: item
        })
        marker.addListener('click', GetDetailInfor);
      })


        var legend = document.getElementById('legend');
        var div = document.createElement('div');
        div.innerHTML = '<img src="https://maps.google.com/mapfiles/kml/pal3/icon63.png">尚有庫存' 
                      + '<br>' 
                      + '<img src="https://maps.google.com/mapfiles/kml/pal5/icon14.png">售罄';
        legend.appendChild(div);
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);

    }

    function GetDetailInfor() {
      let idNum = this.customerProp.id;
      let urlbyid = `https://findmasks.herokuapp.com/places/${idNum}`
      $.ajax({
        type: "GET",
        url: urlbyid,
        success: function (response) {
          detail = response;
          markerInfoWindow.setContent(`
          <div>
            <h5>${detail.properties.name}</h5>
            <p>最後更新時間：<time>${detail.properties.updatedAt}</time></p>
          </div>
          <div>
            <p>成人口罩：${detail.properties.masksLeft}, 兒童口罩：${detail.properties.childMasksLeft}</p>
            <p>地址：${detail.properties.address}</p>
            <p>電話：${detail.properties.phone}</p>
            <small>${detail.properties.note}</small>
          </div>
          `);
        }
      });
      markerInfoWindow.open(map, this);
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
      infoWindow.open(map);
    }

    function changeMap() {
      city.forEach((item) => {
        if (item.name == this.innerText)
          map.setCenter(item.latlng);
      })
    }

    function Getgeojson() {
      console.log('555')
      $.ajax({
        type: "get",
        url: "https://covid19dashboard.cdc.gov.tw/dash1",
        async: true,
        success: function (response) {
          response["features"].sort(function (a, b) {
            // console.log(a["properties"]["cases"],b["properties"]["cases"]);
            return b["properties"]["cases"] - a["properties"]["cases"]
          })
          CreateTable(response["features"]);
        }
      });
    }

    function CreateTable(input) {
      let templateTbody = document.querySelector('#templateTbody'); //抓到模版
      input.forEach((item) => {
        let cloneContent = templateTbody.content.cloneNode(true); //copy
        let country = cloneContent.querySelector('#country');
        let cases = cloneContent.querySelector('#cases');
        let deaths = cloneContent.querySelector('#deaths');
        country.innerText = item["properties"]["name"];
        cases.innerText = item["properties"]["cases"];
        deaths.innerText = item["properties"]["deaths"]
        if (item["properties"]["name"] == "Taiwan") {
          country.classList.add('table-success')
          cases.classList.add('table-success')
          deaths.classList.add('table-success')
        }
        if (item["properties"]["cases"] >= 10000) {
          country.classList.add('table-danger')
          cases.classList.add('table-danger')
          deaths.classList.add('table-danger')
        }
        covid19.appendChild(cloneContent);
      })
    }

    // function CreateNearby
  </script>













  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrKqtaEzK3w7X7G9-AaMovswT_rjHoXmU&callback=initMap"
    async defer></script>
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
  </script>




</body>

</html>