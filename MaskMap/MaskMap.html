<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <title>MaskMap</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
    #map {
      width: 100%;
      height: 667px;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* .navbar-nav .btn p{
      writing-mode: vertical-rl;
      height: max-content;
      margin-bottom: 0;
    } */

    .covid-19 {
      height: 647px;
      position: relative;
    }

    .covid-19 table thead tr th {
      background-color: white;
    }

    #legend {
      font-family: Arial, sans-serif;
      background: #fff;
      padding: 10px;
      margin: 10px;
      border: 3px solid #000;
    }

    #legend h3 {
      margin-top: 0;
    }

    #legend img {
      vertical-align: middle;
    }


    @media screen and (min-width: 376px) {
      .navbar-nav .btn p {
        writing-mode: vertical-rl;
        height: max-content;
        margin-bottom: 0;
      }

      .navbar {
        height: 100px;
      }

    }
  </style>

</head>

<body>


  <div class="container-fluid">

    <div class="row">
      <div class="col-12 col-lg-3 text-center my-1">
        <h2>全球確診人數</h2>
        <h3 id="totaldata"></h3>
        <div class="overflow-auto covid-19">
          <table class="table covid-19-table table-sm position-relative">
            <thead>
              <tr>
                <th class="sticky-top" scope="col">Country</th>
                <th class="sticky-top" scope="col">Cases</th>
                <th class="sticky-top" scope="col">Deaths</th>
              </tr>
            </thead>

            <!-- Information -->
            <template id="templateTbody">
              <tbody id="covid-19-Tbody">
                <tr>
                  <td id="country">Taiwan</td>
                  <td id="cases">252</td>
                  <td id="deaths">33</td>
                </tr>
              </tbody>
            </template>
          </table>
        </div>



      </div>

      <div class="col-12 col-lg-9">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <a class="navbar-brand" href="#">區域</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav m-auto">
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    基隆市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    臺北市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    新北市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    桃園市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    新竹縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    新竹市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    苗栗縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    台中市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    南投縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    嘉義市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    嘉義縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    雲林縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    臺南市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    高雄市
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    屏東縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    臺東縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    花蓮縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    宜蘭縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    澎湖縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    金門縣
                  </p>
                </button>
              </li>
              <li>
                <button type="button" class="btn btn-outline-light">
                  <p>
                    連江縣
                  </p>
                </button>
              </li>
            </ul>
          </div>
        </nav>
        <div id="map"></div>
      </div>




    </div>

  </div>




  <div id="legend" class="b">
    <h5>詳細資訊請點擊圖釘</h5>
  </div>

  <div id="testarea">

    <ul v-for='item in maskData.features'>

      <li>
         {{item.properties.name}}
      </li>

    </ul>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/vue"></script>

  <script>
    var map;
    let maskData = '';
    var maskDataArray = [];
    var infoWindow;
    var markerInfoWindow;
    var detail = '';
    var covid19 = document.querySelector('.covid-19-table');
    var cities = document.querySelectorAll('ul>li .btn');
    var city = [{
      name: "基隆市",
      latlng: {
        lat: 25.1303462,
        lng: 121.7439138
      }
    },
    {
      name: "臺北市",
      latlng: {
        lat: 25.0375465,
        lng: 121.562244
      }
    },
    {
      name: "新北市",
      latlng: {
        lat: 25.0123073,
        lng: 121.4632665
      }
    },
    {
      name: "連江縣",
      latlng: {
        lat: 26.1572524,
        lng: 119.9482926
      }
    },
    {
      name: "宜蘭縣",
      latlng: {
        lat: 24.7305437,
        lng: 121.7619899
      }
    },
    {
      name: "新竹市",
      latlng: {
        lat: 24.7929419,
        lng: 120.9493054
      }
    },
    {
      name: "新竹縣",
      latlng: {
        lat: 24.8268841,
        lng: 121.010715
      }
    },
    {
      name: "桃園市",
      latlng: {
        lat: 24.9931617,
        lng: 121.2988176
      }
    },
    {
      name: "苗栗縣",
      latlng: {
        lat: 24.5648599,
        lng: 120.8185503
      }
    },
    {
      name: "台中市", //24.1892645,120.6090681
      latlng: {
        lat: 24.1892645,
        lng: 120.6090681
      }
    },
    {
      name: "南投縣", //23.9026841,120.6883151
      latlng: {
        lat: 23.9026841,
        lng: 120.6883151
      }
    },
    {
      name: "嘉義市", //23.4812545,120.4514023
      latlng: {
        lat: 23.4812545,
        lng: 120.4514023
      }
    },
    {
      name: "嘉義縣", //23.4586677,120.2907749
      latlng: {
        lat: 23.4586677,
        lng: 120.2907749
      }
    },
    {
      name: "雲林縣", //23.6992351,120.5241337
      latlng: {
        lat: 23.6992351,
        lng: 120.5241337
      }
    },
    {
      name: "臺南市", //22.9922336,120.18299
      latlng: {
        lat: 22.9922336,
        lng: 120.18299
      }
    },
    {
      name: "高雄市", //22.62025,120.3069565
      latlng: {
        lat: 22.62025,
        lng: 120.3069565
      }
    },
    {
      name: "澎湖縣", //23.568495,119.5668485
      latlng: {
        lat: 23.568495,
        lng: 119.5668485
      }
    },
    {
      name: "金門縣", //24.4371954,118.3171488
      latlng: {
        lat: 24.4371954,
        lng: 118.3171488
      }
    },
    {
      name: "屏東縣", //22.6830408,120.4857744
      latlng: {
        lat: 22.6830408,
        lng: 120.4857744
      }
    },
    {
      name: "臺東縣", //22.7539301,121.1429397
      latlng: {
        lat: 22.7539301,
        lng: 121.1429397
      }
    },
    {
      name: "花蓮縣", //23.9848788,121.5721311
      latlng: {
        lat: 23.9848788,
        lng: 121.5721311
      }
    }
    ];

    Getgeojson();
    cities.forEach((item) => {
      item.addEventListener('click', changeMap)
    })

    function initMap() { //程式一開始的入口
      let taipei = {
        lat: 25.0375465,
        lng: 121.562244
      };
      map = new google.maps.Map(document.getElementById('map'), {
        center: taipei,
        zoom: 15,
        styles: [{
          elementType: 'geometry',
          stylers: [{
            color: '#242f3e'
          }]
        },
        {
          elementType: 'labels.text.stroke',
          stylers: [{
            color: '#242f3e'
          }]
        },
        {
          elementType: 'labels.text.fill',
          stylers: [{
            color: '#746855'
          }]
        },
        {
          featureType: 'administrative.locality',
          elementType: 'labels.text.fill',
          stylers: [{
            color: '#d59563'
          }]
        },
        {
          featureType: 'poi',
          elementType: 'labels.text.fill',
          stylers: [{
            color: '#d59563'
          }]
        },
        {
          featureType: 'poi.park',
          elementType: 'geometry',
          stylers: [{
            color: '#263c3f'
          }]
        },
        {
          featureType: 'poi.park',
          elementType: 'labels.text.fill',
          stylers: [{
            color: '#6b9a76'
          }]
        },
        {
          featureType: 'road',
          elementType: 'geometry',
          stylers: [{
            color: '#38414e'
          }]
        },
        {
          featureType: 'road',
          elementType: 'geometry.stroke',
          stylers: [{
            color: '#212a37'
          }]
        },
        {
          featureType: 'road',
          elementType: 'labels.text.fill',
          stylers: [{
            color: '#9ca5b3'
          }]
        },
        {
          featureType: 'road.highway',
          elementType: 'geometry',
          stylers: [{
            color: '#746855'
          }]
        },
        {
          featureType: 'road.highway',
          elementType: 'geometry.stroke',
          stylers: [{
            color: '#1f2835'
          }]
        },
        {
          featureType: 'road.highway',
          elementType: 'labels.text.fill',
          stylers: [{
            color: '#f3d19c'
          }]
        },
        {
          featureType: 'transit',
          elementType: 'geometry',
          stylers: [{
            color: '#2f3948'
          }]
        },
        {
          featureType: 'transit.station',
          elementType: 'labels.text.fill',
          stylers: [{
            color: '#d59563'
          }]
        },
        {
          featureType: 'water',
          elementType: 'geometry',
          stylers: [{
            color: '#17263c'
          }]
        },
        {
          featureType: 'water',
          elementType: 'labels.text.fill',
          stylers: [{
            color: '#515c6d'
          }]
        },
        {
          featureType: 'water',
          elementType: 'labels.text.stroke',
          stylers: [{
            color: '#17263c'
          }]
        }
        ]
      });



      markerInfoWindow = new google.maps.InfoWindow;
      infoWindow = new google.maps.InfoWindow;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map.setCenter(pos);

          let marker = new google.maps.Marker({
            position: pos,
            map: map,
            title: 'You Are Here'
          });
          // CreateNearby(pos);
        }, function () {
          handleLocationError(true, infoWindow, map.getCenter());
        });
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }
      GetDataInfo();

    }

    function GetDataInfo() {
      $.ajax({
        type: "GET",
        // url: "https://raw.githubusercontent.com/hsulei03/BS_homework/master/MaskMap/MaskData.json",
        // url: test1234,
        url: "https://findmasks.herokuapp.com/places",
        async: false,
        success: function (response) {
          // console.log("65598555")
          maskData = response;
          // maskData = JSON.parse(response);
          maskData["features"].forEach((item) => {
            maskDataArray.push({
              id: item.properties.id,
              name: item.properties.name,
              lat: item.geometry.coordinates[1],
              lng: item.geometry.coordinates[0],
              masksLeft: item.properties.masksLeft,
              childMasksLeft: item.properties.childMasksLeft
            })
          });
          setMarkers(map);
        }
      });

    }

    // test
    var vm;
    $(document).ready(function () {
      Binding();
    });
    function Binding() {
      vm = new Vue({
        el: '#testarea',
        data: maskData,
        methods:{
           set: await function () {
            var postionddd = {lat : maskData.features[0].geometry.coordinates[0],lng:maskData.features[0].geometry.coordinates[1]}
            alert('in')
            map.setCenter(postionddd);
            }
        }
      })
    }


    function setMarkers(map) {
      console.log(maskData);
      var image_o = {
        url: 'https://maps.google.com/mapfiles/kml/pal3/icon63.png',
        // This marker is 20 pixels wide by 32 pixels high.
        size: new google.maps.Size(32, 32),
        // The origin for this image is (0, 0).
        origin: new google.maps.Point(0, 0),
        // The anchor for this image is the base of the flagpole at (0, 32).
        anchor: new google.maps.Point(0, 32)
      };

      var image_x = {
        url: 'https://maps.google.com/mapfiles/kml/pal5/icon14.png',
        // This marker is 20 pixels wide by 32 pixels high.
        size: new google.maps.Size(32, 32),
        // The origin for this image is (0, 0).
        origin: new google.maps.Point(0, 0),
        // The anchor for this image is the base of the flagpole at (0, 32).
        anchor: new google.maps.Point(0, 32)
      };

      maskDataArray.forEach((item) => {
        let marker = new google.maps.Marker({
          position: {
            lat: item.lat,
            lng: item.lng
          },
          map: map,
          icon: item.masksLeft + item.childMasksLeft == 0 ? image_x : image_o,
          title: `${item.name}目前：成人有${item.masksLeft}，兒童有${item.childMasksLeft}`,
          customerProp: item
        })
        marker.addListener('click', GetDetailInfor);
      })


      var legend = document.getElementById('legend');
      var div = document.createElement('div');
      div.innerHTML = '<img src="https://maps.google.com/mapfiles/kml/pal3/icon63.png">尚有庫存' +
        '<br>' +
        '<img src="https://maps.google.com/mapfiles/kml/pal5/icon14.png">售罄';
      legend.appendChild(div);
      map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);

    }

    function GetDetailInfor() {
      let idNum = this.customerProp.id;
      let urlbyid = `https://findmasks.herokuapp.com/places/${idNum}`
      $.ajax({
        type: "GET",
        url: urlbyid,
        success: function (response) {
          detail = response;
          console.log(detail);
          markerInfoWindow.setContent(`
          <div>
            <h5>${detail.properties.name}</h5>
            <p>最後更新時間：<time>${detail.properties.updatedAt}</time></p>
          </div>
          <div>
            <p>成人口罩：${detail.properties.masksLeft}, 兒童口罩：${detail.properties.childMasksLeft}</p>
            <p>地址：${detail.properties.address}</p>
            <p>電話：${detail.properties.phone}</p>
            <small>${detail.properties.note}</small>
          </div>
          `);
        }
      });
      markerInfoWindow.open(map, this);
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
      infoWindow.open(map);
    }

    function changeMap() {
      city.forEach((item) => {
        if (item.name == this.innerText)
          map.setCenter(item.latlng);
      })
    }

    var covid19data = ''
    function Getgeojson() {
      console.log('555')
      $.ajax({
        type: "get",
        url: "https://api.covid19api.com/summary",
        async: true,
        success: function (response) {
          covid19data = response;
          CreateTotalData(covid19data);
          // debugger;
          covid19data["Countries"].sort(function (a, b) {
            // console.log(a["TotalConfirmed"],b["TotalConfirmed"]);
            return b["TotalConfirmed"] - a["TotalConfirmed"]
          })
          CreateTable(covid19data["Countries"]);
        }
      });
    }

    function CreateTable(input) {
      let templateTbody = document.querySelector('#templateTbody'); //抓到模版
      input.forEach((item) => {
        let cloneContent = templateTbody.content.cloneNode(true); //copy
        let country = cloneContent.querySelector('#country');
        let cases = cloneContent.querySelector('#cases');
        let deaths = cloneContent.querySelector('#deaths');
        country.innerText = item["Country"];
        cases.innerText = item["TotalConfirmed"];
        deaths.innerText = item["TotalDeaths"]
        if (item["CountryCode"] == "TW") {
          country.classList.add('table-success')
          cases.classList.add('table-success')
          deaths.classList.add('table-success')
        }
        if (item["TotalConfirmed"] >= 10000) {
          country.classList.add('table-danger')
          cases.classList.add('table-danger')
          deaths.classList.add('table-danger')
        }
        covid19.appendChild(cloneContent);
      })
    }

    function CreateTotalData(data) {
      let totalData = document.querySelector('#totaldata');
      totalData.innerText = `確診：${data["Global"]["TotalConfirmed"]},死亡：${data["Global"]["TotalDeaths"]},治癒：${data["Global"]["TotalRecovered"]}`
    }
    // function CreateNearby(data){
    //   console.log(maskDataArray);
    //   maskDataArray.forEach((item) => {
    //     if(item["lat"] <= (data["lat"]- 0.02) || item["lat"] >= (data["lat"]- 0.02) )
    //   })
    // }
  </script>













  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrKqtaEzK3w7X7G9-AaMovswT_rjHoXmU&callback=initMap"
    async defer></script>
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
    </script>




</body>

</html>